name: "Clusters: Compile"
on:
  push:
    branches:
      - main

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  changed-clusters:
    name: Detect changed files
    runs-on: ubuntu-22.04
    timeout-minutes: 3
    outputs:
      changed-clusters: ${{ steps.collect-clusters.outputs.changed-clusters }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Check for file changes
        uses: dorny/paths-filter@v2.11.1
        id: changes
        with:
          list-files: json
          filters: .github/filters.yml

      - name: Collect changed clusters
        id: collect-clusters
        if: |
          steps.changes.outputs.clusters_tanka == 'true'
        shell: bash
        run: |
          PATHS='${{ steps.changes.outputs.clusters_tanka_files }}'
          OUTPUT=$(echo $PATHS | jq --raw-output -c 'map(. |= split("/") | { "cluster": .[1], "env": .[2]})')
          echo "changed-clusters=${OUTPUT}" >> $GITHUB_OUTPUT

  compile:
    name: Compile
    runs-on: ubuntu-latest
    needs:
      - changed-clusters
    if: ${{ needs.changed-clusters.outputs.changed-clusters }} != ''
    strategy:
      matrix:
        cluster: ["${{ fromJson(needs.changed-clusters.outputs.changed-clusters) }}"]
      fail-fast: false
    steps:
      - name: Checkout
        uses: actions/checkout@8e5e7e5ab8b370d6c329ec480221332ada57f0ab # v3
      - name: Setup Tanka
        uses: unfunco/setup-tanka@v1
        with:
          tanka-version: 0.25.0
      - name: Compile manifests
        run: "tk export clusters/${{ matrix.cluster.cluster}}/${{ matrix.cluster.env }}"
